<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>حال‌خوب‌نگار — ثبت روزهای خوب و بد</title>
  <style>
    :root{--bg:#0b1020;--card:#111831;--muted:#9aa4b2;--text:#e6e9ef;--happy:#22c55e;--accent:#60a5fa;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1e,#0e142a);color:var(--text);display:flex;align-items:flex-start;justify-content:center}
    .container{width:min(1100px,92vw);margin:24px auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:var(--accent)}
    .brand h1{margin:0;font-size:1.25rem}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    input[type="text"]{background:#0c1226;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);padding:10px 12px;min-width:220px}
    button{background:#1f2a4a;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 14px;cursor:pointer}
    button:hover{filter:brightness(1.1)}

    .calendar{margin-top:16px}
    .cal-nav{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .cal-nav h2{margin:0;font-size:1.1rem;font-weight:600}
    .weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
    .weekdays div{font-size:.85rem;color:var(--muted);text-align:center}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{aspect-ratio:1/1;border:1px dashed rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;user-select:none;cursor:pointer}
    .day .num{font-size:.95rem;color:var(--muted)}
    .day.is-happy{border-style:solid;border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.12)}
    .day.is-bad{border-style:solid;border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.12)}

    .legend{display:flex;gap:12px;align-items:center;margin-top:12px;color:var(--muted);font-size:.9rem}
    .legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-inline:6px}
    .legend .dot.good{background:var(--happy)}
    .legend .dot.bad{background:var(--danger)}
    .status{margin-top:10px;font-size:.85rem;color:var(--muted)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:.85rem}

    @media (max-width:520px){
      .weekdays div{font-size:.75rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">🙂</div>
        <h1>حال‌خوب‌نگار</h1>
      </div>
    </header>

    <section class="card" id="board">
      <div class="controls">
        <input id="boardId" type="text" placeholder="شناسه‌ی ویژه" readonly>
        <button id="createBoard" type="button">ساخت شناسه جدید</button>
        <button id="copyLink" type="button" disabled>کپی لینک اشتراک</button>
        <span id="copyMsg" class="status"></span>
      </div>

      <div class="calendar" id="calendar">
        <nav class="cal-nav">
          <button id="prevMonth" type="button">◀</button>
          <h2 id="calendar-title">تقویم</h2>
          <button id="nextMonth" type="button">▶</button>
        </nav>

        <div class="weekdays">
          <div>شنبه</div><div>یک‌شنبه</div><div>دوشنبه</div>
          <div>سه‌شنبه</div><div>چهارشنبه</div><div>پنج‌شنبه</div><div>جمعه</div>
        </div>

        <div id="calendar-grid" class="grid"></div>

        <div class="legend">
          <span>راهنما:</span>
          <span><span class="dot good"></span> روز خوب</span>
          <span><span class="dot bad"></span> روز بد</span>
        </div>
        <div class="status" id="saveStatus">وضعیت: آماده.</div>
      </div>
    </section>

    <footer>
      <small>ساخته‌شده برای ثبت لحظه‌های خوب و بد ❤️</small>
    </footer>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBd4r_6QEDLG0dD1C3XiVcHgpkIA700CfQ",
      authDomain: "happy-luna.firebaseapp.com",
      projectId: "happy-luna",
      storageBucket: "happy-luna.appspot.com",
      messagingSenderId: "771017673760",
      appId: "1:771017673760:web:d91617613f639340618045"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Elements
    const calendarGrid = document.getElementById("calendar-grid");
    const calendarTitle = document.getElementById("calendar-title");
    const prevBtn = document.getElementById("prevMonth");
    const nextBtn = document.getElementById("nextMonth");
    const saveStatus = document.getElementById("saveStatus");
    const boardInput = document.getElementById("boardId");
    const createBoardBtn = document.getElementById("createBoard");
    const copyLinkBtn = document.getElementById("copyLink");
    const copyMsg = document.getElementById("copyMsg");

    let currentDate = new Date();
    let happyDays = {};
    let badDays = {};
    let boardId = localStorage.getItem("boardId") || "";

    // ---------- Board ID ----------
    function generateBoardId() {
      return Math.random().toString(36).substring(2, 10);
    }

    function createBoard() {
      boardId = generateBoardId();
      localStorage.setItem("boardId", boardId);
      boardInput.value = boardId;
      copyLinkBtn.disabled = false;
      saveStatus.textContent = "شناسه ساخته شد ✅";
      loadFromFirestore();
    }

    createBoardBtn.addEventListener("click", createBoard);

    copyLinkBtn.addEventListener("click", () => {
      const link = `${window.location.origin}${window.location.pathname}?board=${boardId}`;
      navigator.clipboard.writeText(link);
      copyMsg.textContent = "لینک کپی شد!";
    });

    // اگر لینک با ?board= داشته باشه
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("board")) {
      boardId = urlParams.get("board");
      boardInput.value = boardId;
      copyLinkBtn.disabled = false;
      loadFromFirestore();
    } else if (boardId) {
      boardInput.value = boardId;
      copyLinkBtn.disabled = false;
      loadFromFirestore();
    }

    // ---------- Calendar ----------
    function renderCalendar() {
      calendarGrid.innerHTML = "";

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const monthNames = [
        "ژانویه","فوریه","مارس","آوریل","مه","ژوئن",
        "ژوئیه","اوت","سپتامبر","اکتبر","نوامبر","دسامبر"
      ];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;

      for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
        calendarGrid.appendChild(document.createElement("div"));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.classList.add("day");
        const span = document.createElement("span");
        span.classList.add("num");
        span.textContent = day;
        cell.appendChild(span);

        const key = `${year}-${month + 1}-${day}`;
        if (happyDays[key]) cell.classList.add("is-happy");
        if (badDays[key]) cell.classList.add("is-bad");

        cell.addEventListener("click", () => toggleDay(key, cell));
        calendarGrid.appendChild(cell);
      }
    }

    // ---------- Toggle Days ----------
    function toggleDay(key, cell) {
      if (!boardId) return alert("ابتدا شناسه بسازید!");

      if (happyDays[key]) {
        delete happyDays[key];
        badDays[key] = true;
        cell.classList.remove("is-happy");
        cell.classList.add("is-bad");
      } else if (badDays[key]) {
        delete badDays[key];
        cell.classList.remove("is-bad");
      } else {
        happyDays[key] = true;
        cell.classList.add("is-happy");
      }

      saveToFirestore();
    }

    prevBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    nextBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    // ---------- Firestore ----------
    function saveToFirestore() {
      db.collection("boards").doc(boardId).set({happyDays, badDays})
        .then(() => saveStatus.textContent = "ذخیره شد ✅")
        .catch(() => saveStatus.textContent = "خطا در ذخیره ❌");
    }

    function loadFromFirestore() {
      if (!boardId) return;
      db.collection("boards").doc(boardId).get()
        .then(doc => {
          if (doc.exists) {
            happyDays = doc.data().happyDays || {};
            badDays = doc.data().badDays || {};
            renderCalendar();
            saveStatus.textContent = "داده‌ها بارگذاری شدند ✅";
          }
        })
        .catch(() => saveStatus.textContent = "خطا در بارگذاری ❌");
    }

    // ---------- Init ----------
    renderCalendar();
  </script>
</body>
</html>
